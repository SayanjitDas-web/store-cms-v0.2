<!-- Media Picker Modal -->
<div id="mediaPickerModal" class="fixed inset-0 z-[100] hidden overflow-y-auto" aria-labelledby="modal-title"
    role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm"
        onclick="closeMediaPicker()"></div>

    <div class="flex items-center justify-center min-h-screen p-4 text-center sm:p-0">
        <div
            class="relative bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-5xl sm:w-full h-[80vh] flex flex-col">

            <!-- Header -->
            <div class="bg-white px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Select Media</h3>
                <button onclick="closeMediaPicker()" class="text-gray-400 hover:text-gray-500 transition-colors">
                    <i class="bi bi-x-lg text-lg"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-4 bg-gray-50">
                <div id="mediaPickerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Items loaded via JS -->
                </div>
                <div id="mediaPickerLoading" class="text-center py-10 hidden">
                    <span class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></span>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeMediaPicker()"
                    class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let onMediaSelectCallback = null;
    let mediaPickerLoaded = false;

    function openMediaPicker(callback) {
        onMediaSelectCallback = callback;
        document.getElementById('mediaPickerModal').classList.remove('hidden');
        if (!mediaPickerLoaded) {
            loadMediaPickerImages();
            mediaPickerLoaded = true;
        }
    }

    function closeMediaPicker() {
        document.getElementById('mediaPickerModal').classList.add('hidden');
        onMediaSelectCallback = null;
    }

    async function loadMediaPickerImages() {
        const grid = document.getElementById('mediaPickerGrid');
        const loading = document.getElementById('mediaPickerLoading');

        grid.innerHTML = '';
        loading.classList.remove('hidden');

        try {
            // Fetch first 50 images for picker
            const res = await fetch('/admin/media/api/list?limit=50&skip=0');
            const data = await res.json();

            loading.classList.add('hidden');

            if (data.files.length > 0) {
                data.files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'group relative aspect-square bg-gray-100 rounded-lg overflow-hidden cursor-pointer border-2 border-transparent hover:border-indigo-500';
                    div.innerHTML = `
                        <img src="${file.thumbnail}" class="w-full h-full object-cover" alt="${file.name}">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all"></div>
                    `;
                    div.onclick = () => selectMediaItem(file.url);
                    grid.appendChild(div);
                });
            } else {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">No media found.</p>';
            }
        } catch (err) {
            console.error(err);
            loading.classList.add('hidden');
            grid.innerHTML = '<p class="col-span-full text-center text-red-500 py-10">Error loading media.</p>';
        }
    }

    function selectMediaItem(url) {
        if (onMediaSelectCallback) {
            onMediaSelectCallback(url);
        }
        closeMediaPicker();
    }
</script>